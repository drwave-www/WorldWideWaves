#!/bin/sh
#
# Pre-commit hook for WorldWideWaves
# Runs linting checks on staged Kotlin files before commit
#

# Redirect output to stderr.
exec 1>&2

# Check if there are any staged Kotlin files
staged_kotlin_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts)$' || true)

# Check if there are any staged Swift files
staged_swift_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)

# Check if there are any staged iOS-related files that require Xcode project regeneration
staged_ios_project_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(\.swift$|iosApp/.*\.plist$|iosApp/project\.yml$|shared/src/(commonMain|iosMain)/)' || true)

# Check if there are any staged shell script files
staged_shell_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

# Get all staged source files for header checking
staged_source_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|swift|sh|bash|java|c|cpp|h|hpp|js|ts|py|rb|go|rs)$' || true)

if [ -z "$staged_kotlin_files" ] && [ -z "$staged_swift_files" ] && [ -z "$staged_shell_files" ]; then
    echo "No Kotlin, Swift, or shell script files staged for commit. Skipping lint checks."
    if [ -n "$staged_source_files" ]; then
        echo "Found other source files, checking headers..."
    else
        exit 0
    fi
else
    echo "ğŸ”§ Auto-correcting and validating staged files..."
fi

# Auto-correct and validate Kotlin files
if [ -n "$staged_kotlin_files" ]; then
    echo "Auto-correcting Kotlin style issues..."
    if ./gradlew ktlintFormat --quiet; then
        echo "âœ… Kotlin formatting auto-corrected"
        # Re-stage auto-corrected files
        git add $staged_kotlin_files
    else
        echo "âš ï¸ Some Kotlin formatting issues need manual attention"
    fi

    echo "Running ktlint validation..."
    if ! ./gradlew ktlintCheck --quiet; then
        echo "âŒ ktlint validation failed after auto-correction!"
        echo "Please manually fix remaining issues."
        exit 1
    fi

    echo "Auto-correcting detekt issues..."
    if ./gradlew detekt --auto-correct --quiet 2>/dev/null; then
        echo "âœ… Detekt auto-corrections applied"
        # Re-stage auto-corrected files
        git add $staged_kotlin_files
    else
        echo "âš ï¸ Some detekt issues need manual attention"
    fi

    echo "Running detekt validation..."
    if ! ./gradlew detekt --quiet; then
        echo "âŒ detekt validation failed!"
        echo "Please fix the static analysis issues reported by detekt."
        exit 1
    fi
fi

# Auto-correct and validate Swift files
if [ -n "$staged_swift_files" ]; then
    echo "Auto-correcting Swift style issues..."

    # Check if SwiftLint is available
    if ! command -v swiftlint >/dev/null 2>&1; then
        echo "âŒ SwiftLint is not installed!"
        echo "Please install SwiftLint: brew install swiftlint"
        exit 1
    fi

    # Auto-fix SwiftLint issues
    echo "Applying SwiftLint auto-corrections..."
    if cd iosApp && swiftlint --fix --quiet 2>/dev/null; then
        cd ..
        echo "âœ… Swift auto-corrections applied"
        # Re-stage auto-corrected files
        git add $staged_swift_files
    else
        echo "âš ï¸ Some Swift issues need manual attention"
    fi

    # Run SwiftLint validation from iOS directory
    echo "Running SwiftLint validation..."
    if ! (cd iosApp && swiftlint --quiet); then
        echo "âŒ SwiftLint validation failed after auto-correction!"
        echo "Please manually fix remaining Swift issues."
        exit 1
    fi
fi

# Run shellcheck on shell script files
if [ -n "$staged_shell_files" ]; then
    echo "Running shellcheck on shell scripts..."
    shellcheck_failed=false

    for file in $staged_shell_files; do
        if [ -f "$file" ]; then
            echo "Checking $file..."
            if ! shellcheck -e SC1091 "$file"; then
                shellcheck_failed=true
            fi
        fi
    done

    if [ "$shellcheck_failed" = true ]; then
        echo "âŒ shellcheck failed!"
        echo "Please fix the shell script issues reported by shellcheck."
        exit 1
    fi
fi

echo "âœ… All lint checks passed!"

# Auto-add headers and validate staged source files
if [ -n "$staged_source_files" ]; then
    echo "Auto-adding missing copyright headers..."

    # Check if header script exists
    if [ ! -f "scripts/add-headers.sh" ]; then
        echo "âŒ Header script not found at scripts/add-headers.sh"
        echo "Please ensure the add-headers.sh script exists in the scripts directory."
        exit 1
    fi

    # Auto-add headers to files that need them
    header_changes_made=false
    for file in $staged_source_files; do
        if [ -f "$file" ] && ! head -3 "$file" | grep -q "Copyright"; then
            echo "Adding header to: $file"
            # Create a copy to compare later
            cp "$file" "$file.pre_header"

            # Add header if missing
            if ! scripts/add-headers.sh "$file"; then
                echo "âŒ Failed to process header for $file"
                rm -f "$file.pre_header"
                exit 1
            fi

            # Check if the file was modified
            if ! cmp -s "$file" "$file.pre_header"; then
                echo "âœ… Added header to $file"
                git add "$file"
                header_changes_made=true
            fi

            rm -f "$file.pre_header"
        fi
    done

    if [ "$header_changes_made" = true ]; then
        echo "âœ… Headers added to staged files. Files automatically re-staged."
    else
        echo "âœ… All staged files already have proper headers."
    fi
fi

# Auto-fix trailing whitespace and validate
echo "Auto-correcting trailing whitespace..."

# Get list of staged text files
staged_text_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|swift|sh|bash|java|js|ts|py|rb|go|rs|md|txt|yml|yaml|json)$' || true)

if [ -n "$staged_text_files" ]; then
    whitespace_fixed=false

    for file in $staged_text_files; do
        if [ -f "$file" ]; then
            # Remove trailing whitespace
            if sed -i '' 's/[[:space:]]*$//' "$file" 2>/dev/null; then
                # Check if file was modified
                if git diff --quiet "$file"; then
                    : # No changes
                else
                    echo "âœ… Fixed trailing whitespace in: $file"
                    git add "$file"
                    whitespace_fixed=true
                fi
            fi
        fi
    done

    if [ "$whitespace_fixed" = true ]; then
        echo "âœ… Trailing whitespace auto-corrected and re-staged"
    fi
fi

# Final whitespace validation
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    against=$(git hash-object -t tree /dev/null)
fi

# Check for any remaining whitespace issues
if ! git diff-index --check --cached $against -- >/dev/null 2>&1; then
    echo "âŒ Whitespace issues remain after auto-correction"
    git diff-index --check --cached $against --
    exit 1
fi

echo "âœ… All auto-corrections complete and validation passed!"
