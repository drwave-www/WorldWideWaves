#!/bin/sh
#
# Pre-commit hook for WorldWideWaves
# Runs linting checks on staged Kotlin files before commit
#

# Redirect output to stderr.
exec 1>&2

# Check if there are any staged Kotlin files
staged_kotlin_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts)$' || true)

# Check if there are any staged Swift files
staged_swift_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.swift$' || true)

# Check if there are any staged iOS-related files that require Xcode project regeneration
staged_ios_project_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(\.swift$|iosApp/.*\.plist$|iosApp/project\.yml$|shared/src/(commonMain|iosMain)/)' || true)

# Check if there are any staged shell script files
staged_shell_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

# Get all staged source files for header checking
staged_source_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|swift|sh|bash|java|c|cpp|h|hpp|js|ts|py|rb|go|rs)$' || true)

if [ -z "$staged_kotlin_files" ] && [ -z "$staged_swift_files" ] && [ -z "$staged_shell_files" ]; then
    echo "No Kotlin, Swift, or shell script files staged for commit. Skipping lint checks."
    if [ -n "$staged_source_files" ]; then
        echo "Found other source files, checking headers..."
    else
        exit 0
    fi
else
    echo "üîß Auto-correcting and validating staged files..."
fi

# Auto-correct and validate Kotlin files
if [ -n "$staged_kotlin_files" ]; then
    echo "Auto-correcting Kotlin style issues..."
    if ./gradlew ktlintFormat --quiet; then
        echo "‚úÖ Kotlin formatting auto-corrected"
        # Re-stage auto-corrected files
        git add $staged_kotlin_files
    else
        echo "‚ö†Ô∏è Some Kotlin formatting issues need manual attention"
    fi

    echo "Running ktlint validation..."
    if ! ./gradlew ktlintCheck --quiet; then
        echo "‚ùå ktlint validation failed after auto-correction!"
        echo "Please manually fix remaining issues."
        exit 1
    fi

    echo "Auto-correcting detekt issues..."
    if ./gradlew detekt --auto-correct --quiet 2>/dev/null; then
        echo "‚úÖ Detekt auto-corrections applied"
        # Re-stage auto-corrected files
        git add $staged_kotlin_files
    else
        echo "‚ö†Ô∏è Some detekt issues need manual attention"
    fi

    echo "Running detekt validation..."
    if ! ./gradlew detekt --quiet; then
        echo "‚ùå detekt validation failed!"
        echo "Please fix the static analysis issues reported by detekt."
        exit 1
    fi
fi

# Auto-correct and validate Swift files
if [ -n "$staged_swift_files" ]; then
    echo "Auto-correcting Swift style issues..."

    # Check if SwiftLint is available
    if ! command -v swiftlint >/dev/null 2>&1; then
        echo "‚ùå SwiftLint is not installed!"
        echo "Please install SwiftLint: brew install swiftlint"
        exit 1
    fi

    # Auto-fix SwiftLint issues
    echo "Applying SwiftLint auto-corrections..."
    if cd iosApp && swiftlint --fix --quiet 2>/dev/null; then
        cd ..
        echo "‚úÖ Swift auto-corrections applied"
        # Re-stage auto-corrected files
        git add $staged_swift_files
    else
        echo "‚ö†Ô∏è Some Swift issues need manual attention"
    fi

    # Run SwiftLint validation from iOS directory
    echo "Running SwiftLint validation..."
    if ! (cd iosApp && swiftlint --quiet); then
        echo "‚ùå SwiftLint validation failed after auto-correction!"
        echo "Please manually fix remaining Swift issues."
        exit 1
    fi
fi

# Run shellcheck on shell script files
if [ -n "$staged_shell_files" ]; then
    echo "Running shellcheck on shell scripts..."
    shellcheck_failed=false

    for file in $staged_shell_files; do
        if [ -f "$file" ]; then
            echo "Checking $file..."
            if ! shellcheck -e SC1091 "$file"; then
                shellcheck_failed=true
            fi
        fi
    done

    if [ "$shellcheck_failed" = true ]; then
        echo "‚ùå shellcheck failed!"
        echo "Please fix the shell script issues reported by shellcheck."
        exit 1
    fi
fi

echo "‚úÖ All lint checks passed!"

# Auto-add headers and validate staged source files
if [ -n "$staged_source_files" ]; then
    # Check if header script exists
    if [ ! -f "scripts/add-headers.sh" ]; then
        echo "‚ÑπÔ∏è  Header script not found at scripts/add-headers.sh. Skipping header validation."
        echo "   Copyright headers should be added manually or via IDE templates."
    else
        echo "Auto-adding missing copyright headers..."

    # Auto-add headers to files that need them
    header_changes_made=false
    for file in $staged_source_files; do
        if [ -f "$file" ] && ! head -3 "$file" | grep -q "Copyright"; then
            echo "Adding header to: $file"
            # Create a copy to compare later
            cp "$file" "$file.pre_header"

            # Add header if missing
            if ! scripts/add-headers.sh "$file"; then
                echo "‚ùå Failed to process header for $file"
                rm -f "$file.pre_header"
                exit 1
            fi

            # Check if the file was modified
            if ! cmp -s "$file" "$file.pre_header"; then
                echo "‚úÖ Added header to $file"
                git add "$file"
                header_changes_made=true
            fi

            rm -f "$file.pre_header"
        fi
    done

        if [ "$header_changes_made" = true ]; then
            echo "‚úÖ Headers added to staged files. Files automatically re-staged."
        else
            echo "‚úÖ All staged files already have proper headers."
        fi
    fi
fi

# Auto-fix trailing whitespace and validate
echo "Auto-correcting trailing whitespace..."

# Get list of staged text files
staged_text_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts|swift|sh|bash|java|js|ts|py|rb|go|rs|md|txt|yml|yaml|json)$' || true)

if [ -n "$staged_text_files" ]; then
    whitespace_fixed=false

    for file in $staged_text_files; do
        if [ -f "$file" ]; then
            # Remove trailing whitespace (POSIX-compatible for macOS and Linux)
            # macOS sed requires -i '' while Linux sed requires -i
            if sed --version >/dev/null 2>&1; then
                # GNU sed (Linux)
                sed -i 's/[[:space:]]*$//' "$file" 2>/dev/null
            else
                # BSD sed (macOS)
                sed -i '' 's/[[:space:]]*$//' "$file" 2>/dev/null
            fi

            # Check if file was modified
            if git diff --quiet "$file"; then
                : # No changes
            else
                echo "‚úÖ Fixed trailing whitespace in: $file"
                git add "$file"
                whitespace_fixed=true
            fi
        fi
    done

    if [ "$whitespace_fixed" = true ]; then
        echo "‚úÖ Trailing whitespace auto-corrected and re-staged"
    fi
fi

# Final whitespace validation
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    against=$(git hash-object -t tree /dev/null)
fi

# Check for any remaining whitespace issues
if ! git diff-index --check --cached $against -- >/dev/null 2>&1; then
    echo "‚ùå Whitespace issues remain after auto-correction"
    git diff-index --check --cached $against --
    exit 1
fi

# ============================================================
# MARKDOWN LINTING (OPTIONAL - FAST CHECK ONLY)
# ============================================================
# Lint modified markdown files for consistency
# Only runs if markdownlint-cli2 is installed
# ============================================================

# Get all staged markdown files
staged_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -n "$staged_md_files" ]; then
    # Check if markdownlint-cli2 is installed
    if command -v markdownlint-cli2 >/dev/null 2>&1; then
        echo "Running markdown linting on staged files..."

        # Create a temporary file list for markdownlint
        md_lint_failed=false

        # Run markdownlint with auto-fix on staged files only
        for md_file in $staged_md_files; do
            if [ -f "$md_file" ]; then
                echo "Checking: $md_file"
                if markdownlint-cli2 --fix "$md_file" 2>/dev/null; then
                    # Re-stage if auto-fixed
                    git add "$md_file"
                else
                    echo "‚ö†Ô∏è  Markdown issues in: $md_file"
                    md_lint_failed=true
                fi
            fi
        done

        if [ "$md_lint_failed" = true ]; then
            echo "‚ö†Ô∏è  Some markdown files have linting issues."
            echo "   Most issues were auto-fixed. Please review and re-commit."
            echo "   To skip markdown linting: git commit --no-verify"
            # Don't fail the commit for markdown issues - just warn
            # exit 1
        else
            echo "‚úÖ Markdown linting passed (auto-fixed where needed)"
        fi
    else
        echo "‚ÑπÔ∏è  markdownlint-cli2 not installed. Skipping markdown linting."
        echo "   Install with: npm install -g markdownlint-cli2"
        echo "   Or run: ./scripts/check-docs-links.sh --install"
    fi
fi

echo "‚úÖ All auto-corrections complete and validation passed!"
