name: 99 â€¢ Pipeline Status

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  checks: read
  contents: read
  actions: read

concurrency:
  group: status-${{ github.ref }}
  cancel-in-progress: true

jobs:
  wait-for-workflows:
    name: Wait for Core Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Wait for workflows to complete
        run: |
          echo "Waiting for core workflows to complete..."
          sleep 60  # Wait 1 minute for workflows to register

  status:
    name: Overall Status
    runs-on: ubuntu-latest
    needs: [wait-for-workflows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get workflow runs
        id: workflow-status
        uses: actions/github-script@v7
        with:
          script: |
            // Get all workflow runs for this commit (not just completed)
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: context.sha,
              per_page: 100
            });

            const relevantWorkflows = [
              '03 â€¢ Quality & Security Gates',
              '01 â€¢ Build Android',
              '02 â€¢ Build iOS',
              '05 â€¢ End-to-End Tests'
            ];

            const workflowResults = {};
            let allPassed = true;

            for (const workflow of relevantWorkflows) {
              const run = runs.workflow_runs.find(r => r.name === workflow);
              if (run) {
                if (run.status === 'completed') {
                  workflowResults[workflow] = run.conclusion;
                  if (run.conclusion !== 'success') {
                    allPassed = false;
                  }
                } else {
                  workflowResults[workflow] = run.status; // 'in_progress', 'queued', etc.
                  allPassed = false; // Not completed yet
                }
              } else {
                workflowResults[workflow] = 'not_found';
                allPassed = false;
              }
            }

            console.log('Workflow Results:', workflowResults);
            console.log('All Passed:', allPassed);

            core.setOutput('all_passed', allPassed);
            core.setOutput('results', JSON.stringify(workflowResults));
            return workflowResults;

      - name: Wait for running workflows
        run: |
          echo "Checking for still-running workflows..."

          # Wait up to 45 minutes for workflows to complete (E2E tests can take long)
          timeout=2700
          interval=30
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            running_count=$(gh run list --commit ${{ github.sha }} --json status --jq '[.[] | select(.status == "in_progress" or .status == "queued")] | length')

            if [ "$running_count" -eq 0 ]; then
              echo "âœ… All workflows completed"
              break
            fi

            echo "â³ $running_count workflows still running, waiting..."
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "âš ï¸ Timeout reached, some workflows may still be running"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create status summary
        run: |
          echo "## ðŸš€ WorldWideWaves CI/CD Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Workflow Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse workflow results
          results='${{ steps.workflow-status.outputs.results }}'
          echo "Raw results: $results"

          # Create status table
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gates | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Android | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          echo "| Build iOS | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          echo "| UI Tests | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Coverage Summary:" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests:** Core business logic and utilities" >> $GITHUB_STEP_SUMMARY
          echo "- **UI Tests:** Edge cases, accessibility, visual regression" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests:** Map services, real-time coordination" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### New UI Testing Features:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ **Edge Case Testing:** Device rotation, memory constraints, multi-window" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ **Accessibility Testing:** Screen readers, keyboard navigation, WCAG compliance" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¸ **Screenshot Testing:** Visual regression with baseline comparison" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ **Performance Monitoring:** Integrated across all test categories" >> $GITHUB_STEP_SUMMARY

      - name: Final status check
        run: |
          if [ "${{ steps.workflow-status.outputs.all_passed }}" = "true" ]; then
            echo "âœ… All workflows passed successfully!"
            echo "STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Some workflows failed or are missing"
            echo "STATUS=failure" >> $GITHUB_ENV
            exit 1
          fi