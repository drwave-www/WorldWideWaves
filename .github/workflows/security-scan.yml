# Copyright 2025 DrWave
#
# WorldWideWaves is an ephemeral mobile app designed to orchestrate human waves through cities and
# countries. The project aims to transcend physical and cultural
# boundaries, fostering unity, community, and shared human experience by leveraging real-time
# coordination and location-based services.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only if using Gitleaks Pro

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  firebase-config-check:
    name: Firebase Configuration Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for Firebase config files in git
        run: |
          echo "üîç Checking for Firebase configuration files..."

          # Check if google-services.json is tracked
          if git ls-files | grep -q "^composeApp/google-services.json$"; then
            echo "‚ùå ERROR: google-services.json is tracked in git!"
            echo "This file contains sensitive API keys and should not be committed."
            exit 1
          fi

          # Check if GoogleService-Info.plist is tracked
          if git ls-files | grep -q "GoogleService-Info.plist"; then
            echo "‚ùå ERROR: GoogleService-Info.plist is tracked in git!"
            echo "This file contains sensitive API keys and should not be committed."
            exit 1
          fi

          echo "‚úÖ No Firebase configuration files found in git tracking"

      - name: Scan for Firebase API keys in codebase
        run: |
          echo "üîç Scanning for hardcoded Firebase API keys..."

          # Scan for Firebase API key pattern (excluding template files and docs)
          if git grep -E "AIzaSy[A-Za-z0-9_-]{33}" -- ':(exclude)*.template' ':(exclude)*.md' ':(exclude)docs/' ':(exclude)SECURITY_AUDIT_REPORT.md'; then
            echo "‚ùå ERROR: Firebase API key pattern found in codebase!"
            echo "Remove hardcoded API keys and use environment variables or secrets instead."
            exit 1
          fi

          echo "‚úÖ No hardcoded Firebase API keys found"

  api-key-scan:
    name: API Key Pattern Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Scan for common API key patterns
        run: |
          echo "üîç Scanning for common API key patterns..."

          # Define patterns to search for
          declare -A patterns=(
            ["OpenAI"]="sk-proj-[A-Za-z0-9_-]{48,}"
            ["GitHub Personal Access Token"]="ghp_[A-Za-z0-9]{36}"
            ["GitHub OAuth Token"]="gho_[A-Za-z0-9]{36}"
            ["Slack Bot Token"]="xoxb-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}"
            ["Stripe Secret Key"]="sk_live_[a-zA-Z0-9]{24,}"
            ["AWS Access Key"]="AKIA[A-Z0-9]{16}"
          )

          found_secrets=false

          for key_type in "${!patterns[@]}"; do
            pattern="${patterns[$key_type]}"
            echo "Checking for $key_type..."

            # Scan excluding docs and template files
            if git grep -E "$pattern" -- ':(exclude)*.md' ':(exclude)docs/' ':(exclude)*.template' ':(exclude)SECURITY_AUDIT_REPORT.md' 2>/dev/null; then
              echo "‚ùå Found potential $key_type in codebase"
              found_secrets=true
            fi
          done

          if [ "$found_secrets" = true ]; then
            echo "‚ùå ERROR: Potential API keys or secrets found in codebase!"
            exit 1
          fi

          echo "‚úÖ No common API key patterns found"

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history

      - name: Install TruffleHog
        run: |
          pip install truffleHog

      - name: Run TruffleHog
        run: |
          echo "üîç Running TruffleHog entropy and regex scan..."
          trufflehog --regex --entropy=True --max_depth=100 file://$(pwd) || true
          # Note: TruffleHog can be noisy, so we don't fail on findings
          # Manual review of high-entropy strings recommended

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, firebase-config-check, api-key-scan, trufflehog]
    if: always()

    steps:
      - name: Check overall status
        run: |
          echo "üìä Security Scan Summary"
          echo "========================"
          echo "Gitleaks: ${{ needs.gitleaks.result }}"
          echo "Firebase Config Check: ${{ needs.firebase-config-check.result }}"
          echo "API Key Scan: ${{ needs.api-key-scan.result }}"
          echo "TruffleHog: ${{ needs.trufflehog.result }}"

          if [ "${{ needs.gitleaks.result }}" != "success" ] || \
             [ "${{ needs.firebase-config-check.result }}" != "success" ] || \
             [ "${{ needs.api-key-scan.result }}" != "success" ]; then
            echo "‚ùå Security scan failed! Review the logs above."
            exit 1
          fi

          echo "‚úÖ All security scans passed!"
