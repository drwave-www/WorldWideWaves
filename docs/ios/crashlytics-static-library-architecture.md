# CrashlyticsBridge Static Library Architecture

**Status**: ✅ Production-Ready
**Created**: 2025-11-10
**Last Updated**: 2025-11-10

---

## Executive Summary

Firebase Crashlytics integration on iOS uses a **static library architecture** due to a fundamental limitation of iOS Mach-O binaries: app executables cannot export Objective-C class symbols for dynamic frameworks to import at runtime.

**Key Insight**: The symbol `_OBJC_CLASS_$_CrashlyticsBridge` must be resolved at **framework link time**, not app runtime.

---

## Why a Static Library?

### The Problem

Our Kotlin/Native Shared.framework needs to call Firebase Crashlytics (iOS-only API). The standard approach is:

```
Kotlin → cinterop → Objective-C bridge → Firebase
```

However, this creates a dependency problem on iOS:

#### Failed Approach (Builds 35-38)

```
Shared.framework (Kotlin/Native)
  ↓ uses weak linking: -Wl,-U,_OBJC_CLASS_$_CrashlyticsBridge
  ↓ expects this symbol to exist at runtime
  ↓
iOS App (MH_EXECUTE)
  ↓ compiles CrashlyticsBridge.m
  ↓ symbol exists: _OBJC_CLASS_$_CrashlyticsBridge
  ↓ BUT it's PRIVATE (lowercase 's' in nm output)
  ↓ apps don't export symbols - this is a Mach-O limitation
  ↓
Runtime (dyld)
  ↓ Shared.framework tries to resolve symbol
  ✗ CRASH: symbol not found in flat namespace '_OBJC_CLASS_$_CrashlyticsBridge'
```

**Root Cause**: iOS app executables (MH_EXECUTE) cannot export Objective-C symbols for dynamic frameworks (MH_DYLIB) to import. This is not a bug - it's how iOS binaries work.

### The Solution

**Static Library Approach**:

```
libCrashlyticsBridge.a (static library)
  ├─ CrashlyticsBridge.m
  ├─ CrashlyticsBridge.h
  └─ Links: FirebaseCrashlytics (SPM)
       ↓ built by Xcode for all architectures
       ↓ symbol: _OBJC_CLASS_$_CrashlyticsBridge (public in .a)
       ↓ linked at framework build time
       ↓
Shared.framework (Kotlin/Native)
  ├─ Links: libCrashlyticsBridge.a (at framework link time)
  ├─ Resolves: _OBJC_CLASS_$_CrashlyticsBridge ✅
  └─ No runtime lookup needed - symbol embedded in framework
       ↓ embedded in iOS app
       ↓
iOS App
  ├─ Links: Shared.framework (contains symbol)
  ├─ Links: Firebase frameworks (SPM)
  └─ Result: All symbols consistent, no runtime lookup, no crash ✅
```

**Key Insight**: The symbol is resolved **at framework link time** during `xcodebuild` of Shared.framework, not at app runtime. The static library provides symbols to Kotlin/Native's `konan` linker during framework build.

---

## Project Structure

```
iosApp/
  CrashlyticsBridge/
    CrashlyticsBridge.xcodeproj/      # Xcode static library project
      project.pbxproj                 # Generated by Python script
      xcshareddata/
        xcschemes/
          CrashlyticsBridge.xcscheme
    CrashlyticsBridge/                # Source files
      CrashlyticsBridge.h             # Objective-C header
      CrashlyticsBridge.m             # Objective-C implementation
    CrashlyticsBridgeTests/           # XCTest unit tests
      CrashlyticsBridgeTests.m
    build/                            # Build output (generated)
      libCrashlyticsBridge-universal.a   # Universal binary (arm64, x86_64)
      Release-iphoneos/
        libCrashlyticsBridge.a        # Device binary (arm64)
      Release-iphonesimulator/
        libCrashlyticsBridge.a        # Simulator binary (arm64)
      Release-iphonesimulator-x86/
        libCrashlyticsBridge.a        # Simulator binary (x86_64)

shared/
  build.gradle.kts                    # Gradle automation for static library
  src/
    nativeInterop/cinterop/
      CrashlyticsBridge.def           # cinterop definition
    iosMain/kotlin/.../
      CrashlyticsLogger.ios.kt        # Kotlin implementation
```

---

## Build Process

### Automated via Gradle

The entire build process is fully automated. When you build the iOS framework, Gradle:

1. **Builds static library for all architectures** (arm64 device, arm64 simulator, x86_64 simulator)
2. **Creates universal binary** with `lipo`
3. **Links Shared.framework** against static library
4. **Resolves symbol** `_OBJC_CLASS_$_CrashlyticsBridge` at framework link time

```bash
# Build framework (includes all static library steps automatically)
./gradlew :shared:embedAndSignAppleFrameworkForXcode
```

**What happens under the hood**:

```
1. buildCrashlyticsBridgeIosArm64        → Release-iphoneos/libCrashlyticsBridge.a
2. buildCrashlyticsBridgeSimulatorArm64  → Release-iphonesimulator/libCrashlyticsBridge.a (arm64)
3. buildCrashlyticsBridgeSimulatorX86    → Release-iphonesimulator-x86/libCrashlyticsBridge.a (x86_64)
4. createUniversalCrashlyticsBridge      → libCrashlyticsBridge-universal.a (lipo)
5. linkReleaseFrameworkIosArm64          → Shared.framework (links against .a)
6. Symbol _OBJC_CLASS_$_CrashlyticsBridge now IN framework ✅
```

### Manual Build (if needed)

```bash
# Build static library for all architectures
cd iosApp/CrashlyticsBridge

# Device (arm64)
xcodebuild -project CrashlyticsBridge.xcodeproj \
  -target CrashlyticsBridge \
  -configuration Release \
  -sdk iphoneos \
  -arch arm64 \
  build

# Simulator (arm64)
xcodebuild -project CrashlyticsBridge.xcodeproj \
  -target CrashlyticsBridge \
  -configuration Release \
  -sdk iphonesimulator \
  -arch arm64 \
  build

# Simulator (x86_64)
xcodebuild -project CrashlyticsBridge.xcodeproj \
  -target CrashlyticsBridge \
  -configuration Release \
  -sdk iphonesimulator \
  -arch x86_64 \
  build

# Create universal binary
lipo -create \
  build/Release-iphoneos/libCrashlyticsBridge.a \
  build/Release-iphonesimulator/libCrashlyticsBridge.a \
  build/Release-iphonesimulator-x86/libCrashlyticsBridge.a \
  -output build/libCrashlyticsBridge-universal.a

# Verify architectures
lipo -info build/libCrashlyticsBridge-universal.a
# Expected: Architectures in the fat file: arm64 x86_64 (and arm64 for device)
```

---

## Testing

### Unit Tests (XCTest)

The static library has its own XCTest suite that verifies:

- Class `CrashlyticsBridge` exists
- All 7 methods have correct selectors
- Methods are callable (class responds to selectors)

**Run tests via Gradle**:

```bash
./gradlew runCrashlyticsBridgeTests
```

**Run tests manually**:

```bash
cd iosApp/CrashlyticsBridge
xcodebuild test \
  -project CrashlyticsBridge.xcodeproj \
  -scheme CrashlyticsBridge \
  -destination 'platform=iOS Simulator,name=iPhone 15 Pro'
```

**Note**: Unit tests do NOT test Firebase functionality (requires app initialization context). Integration testing happens via iOS app + existing Kotlin tests.

### Integration Tests

**Existing Kotlin tests** in `shared/src/commonTest/` cover `CrashlyticsLogger` end-to-end:

```bash
./gradlew :shared:testDebugUnitTest
# Expected: 902+ tests pass
```

### Symbol Verification

**Verify symbol exists in framework**:

```bash
# After building framework
nm shared/build/bin/iosArm64/debugFramework/Shared.framework/Shared | \
  grep "_OBJC_CLASS_\$_CrashlyticsBridge"

# Expected output:
# [some address] S _OBJC_CLASS_$_CrashlyticsBridge
#                ↑ capital 'S' = exported symbol (public)
```

**Automated verification via Gradle**:

```bash
./gradlew verifyCrashlyticsBridgeSymbol
```

---

## Troubleshooting

### Symbol Still Missing After Build

**Check these in order**:

1. **Static library built**:

   ```bash
   ls iosApp/build/CrashlyticsBridge/libCrashlyticsBridge-universal.a
   ```

2. **Symbol in .a**:

   ```bash
   nm iosApp/build/CrashlyticsBridge/libCrashlyticsBridge-universal.a | \
     grep CrashlyticsBridge
   # Should see: _OBJC_CLASS_$_CrashlyticsBridge
   ```

3. **Framework linked .a** (check Gradle build logs):

   ```
   Linking debug framework iosArm64
   [... should see libCrashlyticsBridge-universal.a in link command ...]
   ```

4. **Symbol in framework**:

   ```bash
   nm shared/build/bin/iosArm64/debugFramework/Shared.framework/Shared | \
     grep CrashlyticsBridge
   # Should see: [address] S _OBJC_CLASS_$_CrashlyticsBridge
   ```

### Build Fails with Firebase Not Found

**Cause**: Firebase SPM dependency not resolved in static library project.

**Fix**:

```bash
# Open project in Xcode
cd iosApp/CrashlyticsBridge
open CrashlyticsBridge.xcodeproj

# In Xcode:
# 1. Wait for package resolution (status bar shows progress)
# 2. File → Packages → Resolve Package Versions
# 3. Rebuild via Gradle
```

### XCTest Tests Fail

**Limitation**: Firebase requires app initialization context. Unit tests verify:

- Methods exist
- Selectors are correct
- Class can be loaded

Full integration testing happens via iOS app + existing Kotlin tests (902+ tests).

### Gradle Build Slow

**Cause**: Building 3 architecture variants + universal binary takes time on first build.

**Optimization**:

- Subsequent builds use Gradle task caching (inputs/outputs tracking)
- Clean build: ~30-60 seconds
- Incremental build: <5 seconds (if no .m/.h changes)

---

## Maintenance

### When to Rebuild

**Rebuild static library when**:

- `CrashlyticsBridge.m` or `.h` changes
- Firebase Crashlytics version updates in main app
- New iOS architectures added (unlikely)

**Gradle handles this automatically** via task input/output tracking.

### Version Compatibility

- **iOS Deployment Target**: 16.0+ (matches main app)
- **Firebase version**: Managed by SPM in main app (stays in sync)
- **Xcode version**: 15.3+ required for project format
- **Architectures**: arm64 (device + simulator), x86_64 (simulator)

### Adding New Methods

1. **Add to CrashlyticsBridge.h** (declare method)
2. **Implement in CrashlyticsBridge.m**
3. **Add XCTest** in `CrashlyticsBridgeTests.m`
4. **Rebuild**: `./gradlew createUniversalCrashlyticsBridge`
5. **Update Kotlin**: Add call in `CrashlyticsLogger.ios.kt`
6. **Test**: `./gradlew :shared:testDebugUnitTest`

---

## Alternative Approaches (Why They Failed)

### 1. Swift @objc Implementation

**Attempted**: Implement bridge in Swift with `@objc` annotation.

**Result**: ❌ Linker stripped Objective-C metadata. Symbol existed in development builds but disappeared with optimizations.

**Why**: Swift's `@objc` creates Swift symbols, not true Objective-C symbols. Dead code stripping removes "unused" ObjC metadata.

### 2. Export Flags on App

**Attempted**: Use linker flags to force app to export symbols:

- `-Wl,-exported_symbol,_OBJC_CLASS_$_CrashlyticsBridge`
- `-rdynamic`
- `exported_symbols_list` file

**Result**: ❌ All ignored. iOS apps simply don't export symbols.

**Why**: MH_EXECUTE binaries on iOS are consumers, not providers.

### 3. DEAD_CODE_STRIPPING = NO

**Attempted**: Disable dead code stripping in app.

**Result**: ❌ Symbol exists but still private (lowercase 's' in nm).

**Why**: Stripping is about removal, not visibility. Symbol was never public.

### 4. Direct Platform API Calls

**Attempted**: Call Firebase directly from Kotlin/Native without bridge.

**Result**: ❌ Firebase not available at Kotlin/Native compile time.

**Why**: Firebase is an SPM dependency of the iOS app, not available to framework.

### 5. Weak Linking Only

**Current broken approach**: Use `-Wl,-U,_OBJC_CLASS_$_CrashlyticsBridge` and hope app provides symbol.

**Result**: ❌ App compiles symbol into binary, but it's private - runtime crash.

**Why**: This is the problem we're solving with the static library.

---

## Implementation History

### Builds 35-38 (Failed)

- Used weak linking in framework
- Compiled CrashlyticsBridge.m into app
- Symbol existed but was private
- **Crash on launch**: "symbol not found in flat namespace"

### Build 39+ (Working)

- Implemented static library architecture
- Symbol resolved at framework link time
- No runtime lookup needed
- **Launches successfully** ✅

---

## References

- **Mach-O symbol visibility**: [Apple Developer - Mach-O Programming Topics](https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/MachOTopics/)
- **Kotlin/Native cinterop**: [Kotlin Documentation - C Interop](https://kotlinlang.org/docs/native-c-interop.html)
- **Static vs Dynamic linking**: [Apple Developer - Dynamic Library Programming Topics](https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/)
- **Firebase iOS SDK**: [Firebase GitHub Repository](https://github.com/firebase/firebase-ios-sdk)

---

## Related Documentation

- [CLAUDE_iOS.md](../../CLAUDE_iOS.md) - Complete iOS development guide
- [CLAUDE.md](../../CLAUDE.md) - Main project documentation
- [CRASHLYTICS_STATIC_LIBRARY_IMPLEMENTATION_PLAN.md](CRASHLYTICS_STATIC_LIBRARY_IMPLEMENTATION_PLAN.md) - Original implementation plan

---

**Last Updated**: 2025-11-10
**Maintainer**: WorldWideWaves Development Team
